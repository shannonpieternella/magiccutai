<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Editor - MagicCutAI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0b2e 25%, #16213e 75%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }

        /* Background Effects */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255, 0, 110, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(131, 56, 236, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(58, 134, 255, 0.1) 0%, transparent 70%);
            pointer-events: none;
            animation: backgroundShift 20s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Navigation */
        nav {
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #ff006e, #8338ec, #3a86ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
            text-decoration: none;
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .nav-links a {
            color: #fff;
            text-decoration: none;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 5px;
        }
        
        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .nav-links a.active {
            background: linear-gradient(45deg, #ff006e, #8338ec);
        }
        
        /* Main Container */
        .editor-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }
        
        /* Header */
        .editor-header {
            text-align: center;
            margin-bottom: 50px;
        }
        
        .editor-header h1 {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #ff006e, #8338ec, #3a86ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .editor-header p {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* Template Info Card */
        .template-info {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            text-align: center;
        }
        
        .template-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #fff;
        }
        
        .template-requirements {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .requirement-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .requirement-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .requirement-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .requirement-number {
            font-size: 36px;
            font-weight: bold;
            background: linear-gradient(45deg, #ff006e, #8338ec);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .requirement-label {
            color: rgba(255, 255, 255, 0.8);
            margin-top: 5px;
        }
        
        /* Editor Workspace */
        .editor-workspace {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 40px;
        }
        
        /* Media Selection */
        .section-title {
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .media-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.05);
            padding: 5px;
            border-radius: 10px;
            width: fit-content;
        }
        
        .media-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 500;
        }
        
        .media-tab.active {
            background: linear-gradient(45deg, #ff006e, #8338ec);
            color: white;
        }
        
        /* Scene Cards */
        .scenes-grid {
            display: grid;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .scene-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 30px;
            transition: all 0.3s ease;
        }
        
        .scene-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .scene-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .scene-number {
            font-size: 20px;
            font-weight: 600;
            background: linear-gradient(45deg, #ff006e, #8338ec);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .scene-content {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 30px;
            align-items: start;
        }
        
        .media-selector-box {
            text-align: center;
        }
        
        .media-placeholder {
            width: 200px;
            height: 112px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
        }
        
        .media-placeholder:hover {
            border-color: #ff006e;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .media-placeholder.has-media {
            border: 2px solid #8338ec;
        }
        
        .media-placeholder img,
        .media-placeholder video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .placeholder-text {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
        }
        
        .text-input-box {
            flex: 1;
        }
        
        .text-input-box label {
            display: block;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }
        
        .text-input {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
            resize: vertical;
            min-height: 100px;
        }
        
        .text-input:focus {
            outline: none;
            border-color: #8338ec;
            background: rgba(255, 255, 255, 0.08);
        }
        
        /* Media Grid Modal */
        .media-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding: 40px;
            overflow-y: auto;
        }
        
        .media-modal-content {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(10, 10, 10, 0.95);
            border-radius: 20px;
            padding: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .media-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .close-modal {
            font-size: 30px;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .close-modal:hover {
            color: white;
        }
        
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .media-item {
            aspect-ratio: 16/9;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .media-item:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(131, 56, 236, 0.3);
        }
        
        .media-item img,
        .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .media-item-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
            color: white;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .media-item:hover .media-item-overlay {
            opacity: 1;
        }
        
        .delete-media-btn:hover {
            background: #cc0055 !important;
            transform: scale(1.05);
        }
        
        /* Music Section */
        .music-section {
            margin-top: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
        }
        
        .music-input {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            margin-top: 10px;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }
        
        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #ff006e, #8338ec);
            color: white;
            box-shadow: 0 10px 30px rgba(131, 56, 236, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(131, 56, 236, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        /* Preview Section */
        .preview-section {
            margin-top: 40px;
            text-align: center;
            display: none;
        }
        
        .preview-container {
            max-width: 400px;
            margin: 0 auto;
            background: black;
            border-radius: 20px;
            overflow: hidden;
            aspect-ratio: 9/16;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .preview-container video {
            width: 100%;
            height: 100%;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .loading-content {
            text-align: center;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #8338ec;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 24px;
            color: white;
            margin-bottom: 10px;
        }
        
        .loading-subtext {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        /* Hamburger Menu */
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            z-index: 101;
        }
        
        .hamburger span {
            width: 25px;
            height: 3px;
            background: #fff;
            margin: 3px 0;
            transition: 0.3s;
        }
        
        .hamburger.active span:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }
        
        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger.active span:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }
        
        /* Mobile Menu */
        .mobile-nav {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100vh;
            background: rgba(10, 10, 10, 0.98);
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: 0.3s;
            z-index: 99;
        }
        
        .mobile-nav.active {
            right: 0;
        }
        
        .mobile-nav a {
            color: #fff;
            text-decoration: none;
            padding: 1rem 2rem;
            margin: 0.5rem 0;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            border-radius: 10px;
        }
        
        .mobile-nav a:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .mobile-nav a.active {
            background: linear-gradient(45deg, #ff006e, #8338ec);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            nav {
                padding: 1rem;
            }
            
            .nav-links {
                display: none;
            }
            
            .hamburger {
                display: flex;
            }
            
            .editor-container {
                padding: 20px 10px;
            }
            
            .editor-header h1 {
                font-size: 2rem;
            }
            
            .template-info {
                padding: 1.5rem;
            }
            
            .template-title {
                font-size: 24px;
            }
            
            .template-requirements {
                grid-template-columns: 1fr;
            }
            
            .scene-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .media-placeholder {
                max-width: 100%;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="/index.html" class="logo" style="text-decoration: none; cursor: pointer;">MagicCutAI</a>
            <div class="nav-links">
                <a href="/app">Create Videos</a>
                <a href="/templates">Templates</a>
                <a href="/editor" class="active">Editor</a>
                <a href="/edits">My Edits</a>
                <a href="/videos">My Videos</a>
                <span id="creditDisplay" style="padding: 0.5rem 1rem; background: rgba(131, 56, 236, 0.2); border-radius: 20px; margin: 0 1rem;">
                    üí≥ <span id="creditCount">0</span> Credits
                </span>
                <a href="#" id="logoutBtn">Logout</a>
            </div>
            <div class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>
    
    <!-- Mobile Navigation -->
    <div class="mobile-nav" id="mobileNav">
        <a href="/app">Create Videos</a>
        <a href="/templates">Templates</a>
        <a href="/editor" class="active">Editor</a>
        <a href="/edits">My Edits</a>
        <a href="/videos">My Videos</a>
        <a href="#" onclick="logout()">Logout</a>
    </div>

    <div class="editor-container">
        <div class="editor-header">
            <h1>Video Editor</h1>
            <p>Create stunning videos with our dynamic template</p>
        </div>

        <div class="template-info">
            <h2 class="template-title">Dynamic Story Template</h2>
            <p>Perfect for TikTok, Instagram Reels, and YouTube Shorts</p>
            
            <div class="template-requirements">
                <div class="requirement-card">
                    <div class="requirement-icon">üé¨</div>
                    <div class="requirement-number">4</div>
                    <div class="requirement-label">Videos or Images</div>
                </div>
                <div class="requirement-card">
                    <div class="requirement-icon">üí¨</div>
                    <div class="requirement-number">4</div>
                    <div class="requirement-label">Text Overlays</div>
                </div>
                <div class="requirement-card">
                    <div class="requirement-icon">üéµ</div>
                    <div class="requirement-number">1</div>
                    <div class="requirement-label">Background Music</div>
                </div>
                <div class="requirement-card">
                    <div class="requirement-icon">‚è±Ô∏è</div>
                    <div class="requirement-number">30s</div>
                    <div class="requirement-label">Total Duration</div>
                </div>
            </div>
        </div>

        <div class="editor-workspace">
            <h3 class="section-title">
                <span>üì∏</span>
                <span>Select Your Media</span>
            </h3>
            
            <div class="media-tabs">
                <button class="media-tab active" data-type="videos">Videos</button>
                <button class="media-tab" data-type="images">Images</button>
            </div>

            <div id="scenesContainer">
                <div class="scenes-grid" id="scenesGrid">
                    <!-- Scene cards will be dynamically generated here -->
                </div>
            </div>

            <div class="music-section">
                <h3 class="section-title">
                    <span>üéµ</span>
                    <span>Background Music (Optional)</span>
                </h3>
                <input type="url" class="music-input" id="musicUrl" placeholder="Enter music URL (MP3 format)" value="https://creatomate.com/files/assets/b5dc815e-dcc9-4c62-9405-f94913936bf5">
            </div>

            <div class="preview-section" id="previewSection">
                <h3 class="section-title" style="justify-content: center; margin-bottom: 30px;">
                    <span>üëÅÔ∏è</span>
                    <span>Preview</span>
                </h3>
                <div class="preview-container">
                    <video id="previewVideo" controls></video>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="resetForm()">
                    <span>üîÑ</span>
                    <span>Reset</span>
                </button>
                <button class="btn btn-primary" onclick="renderVideo()">
                    <span>‚ú®</span>
                    <span>Create Video (4 Credits)</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Media Selection Modal -->
    <div class="media-modal" id="mediaModal">
        <div class="media-modal-content">
            <div class="media-modal-header">
                <h3>Select Media for Scene <span id="currentScene">1</span></h3>
                <span class="close-modal" onclick="closeMediaModal()">&times;</span>
            </div>
            
            <!-- Upload Section -->
            <div class="upload-section" style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <h4 style="margin-bottom: 15px;">Upload Your Own Media</h4>
                <div class="upload-container" style="display: flex; gap: 15px; align-items: center;">
                    <input type="file" id="fileInput" accept="image/*,video/*" style="display: none;" onchange="handleFileSelect(event)">
                    <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()" style="display: flex; align-items: center; gap: 10px;">
                        <span>üì§</span>
                        <span>Choose File</span>
                    </button>
                    <span id="selectedFileName" style="color: rgba(255,255,255,0.7); font-size: 14px;"></span>
                </div>
                <div id="uploadProgress" style="display: none; margin-top: 15px;">
                    <div style="background: rgba(255,255,255,0.1); border-radius: 5px; height: 8px; overflow: hidden;">
                        <div id="progressBar" style="background: linear-gradient(45deg, #ff006e, #8338ec); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <span id="uploadStatus" style="font-size: 14px; color: rgba(255,255,255,0.7); margin-top: 5px; display: block;"></span>
                </div>
            </div>
            
            <div class="media-grid" id="mediaGrid">
                <!-- Media will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3 class="loading-text">Creating your video...</h3>
            <p class="loading-subtext">This may take a few moments</p>
        </div>
    </div>

    <script>
        // Constants
        let TEMPLATE_ID = "ef99b063-c6f5-4e9f-bd70-ba4c3758b2ac"; // Default template
        const token = localStorage.getItem('token');
        const CREDITS_PER_VIDEO = 4;
        
        // State
        let currentTemplate = null;
        let currentSceneNumber = null;
        let selectedMedia = {};
        let userCredits = 0;
        let mediaLibrary = {
            videos: [],
            images: []
        };
        let currentMediaType = 'videos';

        // Check authentication
        if (!token) {
            window.location.href = '/login';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication and subscription
            await checkUserAccess();
            
            // Check if template was selected from templates page
            const selectedTemplateId = sessionStorage.getItem('selectedTemplateId');
            if (selectedTemplateId && selectedTemplateId !== 'default') {
                await loadTemplate(selectedTemplateId);
                sessionStorage.removeItem('selectedTemplateId');
            } else {
                // Use default template
                setupDefaultTemplate();
            }
            
            loadUserMedia();
            setupEventListeners();
        });
        
        // Check user access
        async function checkUserAccess() {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    window.location.href = '/login';
                    return;
                }
                
                const data = await response.json();
                const user = data.user;
                
                // Update credits display
                userCredits = user.credits?.available || 0;
                document.getElementById('creditCount').textContent = userCredits;
                
                // Check if user is subscribed
                const isSubscribed = user.subscription?.status === 'active' && user.subscription?.plan !== 'free';
                
                if (!isSubscribed) {
                    alert('You need an active subscription to access the video editor. Please upgrade your plan.');
                    window.location.href = '/pricing';
                    return;
                }
            } catch (error) {
                console.error('Access check failed:', error);
                window.location.href = '/login';
            }
        }

        // Load template from database
        async function loadTemplate(templateId) {
            try {
                const response = await fetch(`/api/templates/${templateId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentTemplate = data.template;
                    
                    // Check template type
                    if (currentTemplate.templateType === 'creatomate') {
                        setupCreatomateTemplate();
                    } else {
                        TEMPLATE_ID = currentTemplate.templateId;
                        setupTemplateUI();
                    }
                } else {
                    console.error('Failed to load template, using default');
                    setupDefaultTemplate();
                }
            } catch (error) {
                console.error('Error loading template:', error);
                setupDefaultTemplate();
            }
        }

        // Setup default template
        function setupDefaultTemplate() {
            currentTemplate = {
                name: 'Dynamic Story Template',
                description: 'Perfect for TikTok, Instagram Reels, and YouTube Shorts',
                templateId: 'ef99b063-c6f5-4e9f-bd70-ba4c3758b2ac',
                scenes: 4,
                duration: 30,
                aspectRatio: '9:16',
                fields: [
                    { name: 'Text-1.text', type: 'text', label: 'Scene 1 Text', defaultValue: 'Did you know you can automate TikTok, Instagram, and YouTube videos? üî•', scene: 1 },
                    { name: 'Text-2.text', type: 'text', label: 'Scene 2 Text', defaultValue: 'Use any video automation tool to replace these text and background assets with your own! üòä', scene: 2 },
                    { name: 'Text-3.text', type: 'text', label: 'Scene 3 Text', defaultValue: 'Learn how to get started on the Guides & Tutorials page on Creatomate\'s home page.', scene: 3 },
                    { name: 'Text-4.text', type: 'text', label: 'Scene 4 Text', defaultValue: 'Use the template editor to completely customize this video to meet your own needs. üöÄ', scene: 4 },
                    { name: 'Music.source', type: 'music', label: 'Background Music', defaultValue: 'https://creatomate.com/files/assets/b5dc815e-dcc9-4c62-9405-f94913936bf5' }
                ],
                mediaSlots: [
                    { name: 'Background-1.source', type: 'video_or_image', scene: 1, label: 'Scene 1 Media' },
                    { name: 'Background-2.source', type: 'video_or_image', scene: 2, label: 'Scene 2 Media' },
                    { name: 'Background-3.source', type: 'video_or_image', scene: 3, label: 'Scene 3 Media' },
                    { name: 'Background-4.source', type: 'video_or_image', scene: 4, label: 'Scene 4 Media' }
                ]
            };
            TEMPLATE_ID = currentTemplate.templateId;
            setupTemplateUI();
        }

        // Setup UI based on template
        function setupTemplateUI() {
            // Update template info
            document.querySelector('.template-title').textContent = currentTemplate.name;
            const templateDesc = document.querySelector('.template-info p');
            if (templateDesc) {
                templateDesc.textContent = currentTemplate.description || 'Create amazing videos with this template';
            }
            
            // Update requirements if we have the elements
            const scenesReq = document.querySelector('.template-requirements .requirement-number');
            if (scenesReq) {
                scenesReq.textContent = currentTemplate.scenes;
            }
            
            // Initialize selectedMedia based on scenes
            selectedMedia = {};
            for (let i = 1; i <= currentTemplate.scenes; i++) {
                selectedMedia[i] = null;
            }
            
            // Generate scene cards dynamically
            generateSceneCards();
        }
        
        // Setup Creatomate template
        function setupCreatomateTemplate() {
            // Use the same UI as JSON templates
            document.querySelector('.template-title').textContent = currentTemplate.name;
            const templateDesc = document.querySelector('.template-info p');
            if (templateDesc) {
                templateDesc.textContent = currentTemplate.description || 'Create amazing videos with this template';
            }
            
            // Use scenes count for Creatomate templates
            // Scenes should be based on media slots, not text fields
            // Multiple text fields can be in one scene
            const scenesCount = currentTemplate.scenes || 
                              (currentTemplate.mediaSlots ? currentTemplate.mediaSlots.length : 1);
            currentTemplate.scenes = scenesCount; // Set scenes for consistency
            
            // Update requirements to match JSON template style
            const requirementsContainer = document.querySelector('.template-requirements');
            if (requirementsContainer) {
                requirementsContainer.innerHTML = `
                    <div class="requirement-card">
                        <div class="requirement-icon">üé¨</div>
                        <div class="requirement-number">${scenesCount}</div>
                        <div class="requirement-label">Videos or Images</div>
                    </div>
                    <div class="requirement-card">
                        <div class="requirement-icon">üí¨</div>
                        <div class="requirement-number">${currentTemplate.fields?.filter(f => f.type === 'text').length || scenesCount}</div>
                        <div class="requirement-label">Text Overlays</div>
                    </div>
                    <div class="requirement-card">
                        <div class="requirement-icon">üéµ</div>
                        <div class="requirement-number">1</div>
                        <div class="requirement-label">Background Music</div>
                    </div>
                    <div class="requirement-card">
                        <div class="requirement-icon">‚è±Ô∏è</div>
                        <div class="requirement-number">${currentTemplate.duration || 30}s</div>
                        <div class="requirement-label">Total Duration</div>
                    </div>
                `;
            }
            
            // Initialize selected media based on scenes (like JSON templates)
            selectedMedia = {};
            for (let i = 1; i <= scenesCount; i++) {
                selectedMedia[i] = null;
            }
            
            // Generate scene cards using the same UI as JSON templates
            generateSceneCards();
        }
        

        // Load user media
        async function loadUserMedia() {
            try {
                // Reset media library
                mediaLibrary = {
                    videos: [],
                    images: []
                };
                
                // Load all data in parallel for better performance
                const [videosResponse, imagesResponse] = await Promise.all([
                    fetch('/api/videos/library?limit=1000', {  // Get all videos, not just 20
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }),
                    fetch('/api/image-gallery?limit=1000', {  // Get all images too
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                ]);
                
                // Process videos
                if (videosResponse.ok) {
                    const videosData = await videosResponse.json();
                    mediaLibrary.videos = videosData.videos || [];
                    console.log('Loaded videos:', mediaLibrary.videos.length);
                    console.log('Video data:', videosData);
                    // Log any uploaded videos
                    const uploadedVideos = mediaLibrary.videos.filter(v => v.isUploaded);
                    console.log('Uploaded videos found:', uploadedVideos.length, uploadedVideos);
                }

                // Process images
                if (imagesResponse.ok) {
                    const imagesData = await imagesResponse.json();
                    mediaLibrary.images = imagesData.images || [];
                    console.log('Loaded images:', mediaLibrary.images.length);
                }
                
                // We don't need to load uploaded media from /api/auth/me anymore
                // because it's now included in the image-gallery and videos/library responses
            } catch (error) {
                console.error('Error loading media:', error);
            }
            
            // If media modal is open, refresh the display
            if (document.getElementById('mediaModal').style.display === 'flex') {
                displayMediaGrid();
            }
        }

        // Update credits display
        function updateCreditsDisplay() {
            const creditElement = document.getElementById('creditCount');
            if (creditElement) {
                creditElement.textContent = userCredits;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Media type tabs
            document.querySelectorAll('.media-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.media-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentMediaType = tab.dataset.type;
                });
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('token');
                window.location.href = '/login';
            });
            
            // Mobile menu toggle
            const hamburger = document.getElementById('hamburger');
            const mobileNav = document.getElementById('mobileNav');
            
            if (hamburger && mobileNav) {
                hamburger.addEventListener('click', () => {
                    hamburger.classList.toggle('active');
                    mobileNav.classList.toggle('active');
                });
                
                // Close mobile menu when clicking outside
                document.addEventListener('click', (e) => {
                    if (!hamburger.contains(e.target) && !mobileNav.contains(e.target)) {
                        hamburger.classList.remove('active');
                        mobileNav.classList.remove('active');
                    }
                });
            }

            // Close modal on outside click
            document.getElementById('mediaModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('mediaModal')) {
                    closeMediaModal();
                }
            });
        }

        // Generate scene cards dynamically
        function generateSceneCards() {
            const grid = document.getElementById('scenesGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            // Get all text fields and media slots
            const textFields = currentTemplate.fields ? currentTemplate.fields.filter(f => f.type === 'text') : [];
            const mediaSlots = currentTemplate.mediaSlots || [];
            
            for (let i = 1; i <= currentTemplate.scenes; i++) {
                // Find text field for this scene - more flexible matching
                let textField = textFields.find(f => 
                    f.name.includes(`Text-${i}`) || 
                    f.name.includes(`Text ${i}`) ||
                    (f.scene === i && f.type === 'text')
                );
                
                // If no field found and we have unassigned text fields, use them in order
                if (!textField && textFields.length > 0) {
                    const unassignedFields = textFields.filter(f => !f.scene || f.scene === 1);
                    if (unassignedFields[i - 1]) {
                        textField = unassignedFields[i - 1];
                    }
                }
                
                // Find media slot for this scene - more flexible matching
                let mediaSlot = mediaSlots.find(m => 
                    m.scene === i ||
                    m.name.includes(`${i}`) ||
                    m.name.includes(`Video`) && mediaSlots.length === 1 // If only one video slot, use it for all scenes
                );
                
                // If no slot found and we have unassigned slots, use them in order
                if (!mediaSlot && mediaSlots.length > 0) {
                    const unassignedSlots = mediaSlots.filter(m => !m.scene || m.scene === 1);
                    if (unassignedSlots[i - 1]) {
                        mediaSlot = unassignedSlots[i - 1];
                    }
                }
                
                const sceneCard = document.createElement('div');
                sceneCard.className = 'scene-card';
                sceneCard.dataset.scene = i;
                
                // For templates with 1 scene and multiple text fields, show all text fields
                let textInputsHTML = '';
                if (currentTemplate.scenes === 1 && textFields.length > 1) {
                    // Show all text fields for single scene templates
                    textFields.forEach((field, index) => {
                        textInputsHTML += `
                            <div class="text-input-box" style="margin-bottom: 15px;">
                                <label for="text_${field.name}">${field.label}</label>
                                <textarea 
                                    class="text-input" 
                                    id="text_${field.name}" 
                                    data-field-name="${field.name}"
                                    placeholder="${field.placeholder || `Enter ${field.label}...`}"
                                >${field.defaultValue || ''}</textarea>
                            </div>
                        `;
                    });
                } else {
                    // Show single text field per scene
                    textInputsHTML = `
                        <div class="text-input-box">
                            <label for="text${i}">${textField ? textField.label : `Scene ${i} Text`}</label>
                            <textarea 
                                class="text-input" 
                                id="text${i}" 
                                data-field-name="${textField ? textField.name : `Text-${i}.text`}"
                                placeholder="${textField ? textField.placeholder || `Enter text for scene ${i}...` : `Enter text for scene ${i}...`}"
                            >${textField && textField.defaultValue ? textField.defaultValue : ''}</textarea>
                        </div>
                    `;
                }
                
                sceneCard.innerHTML = `
                    <div class="scene-header">
                        <h4 class="scene-number">Scene ${i}</h4>
                    </div>
                    <div class="scene-content">
                        <div class="media-selector-box">
                            <div class="media-placeholder" id="mediaPlaceholder${i}" onclick="openMediaSelector(${i})">
                                <span class="placeholder-text">Click to select media</span>
                            </div>
                            <p style="margin-top: 10px; font-size: 14px; color: rgba(255,255,255,0.6);">${mediaSlot ? mediaSlot.label || 'Video or Image' : 'Video or Image'}</p>
                        </div>
                        ${textInputsHTML}
                    </div>
                `;
                
                grid.appendChild(sceneCard);
            }
            
            // Store music URL if available
            const musicField = currentTemplate.fields ? currentTemplate.fields.find(f => f.type === 'music') : null;
            if (musicField && musicField.defaultValue) {
                window.musicUrl = musicField.defaultValue;
            }
        }
        
        // Open media selector
        async function openMediaSelector(sceneNumber) {
            currentSceneNumber = sceneNumber;
            document.getElementById('currentScene').textContent = sceneNumber;
            // Reload media library to get latest uploads
            await loadUserMedia();
            displayMediaGrid();
            document.getElementById('mediaModal').style.display = 'flex';
        }

        // Close media modal
        function closeMediaModal() {
            document.getElementById('mediaModal').style.display = 'none';
            currentSceneNumber = null;
        }
        
        // Logout function
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login';
        }

        // Display media grid
        function displayMediaGrid() {
            const grid = document.getElementById('mediaGrid');
            
            // Show loading state if library is still loading
            if (!mediaLibrary || (!mediaLibrary.videos && !mediaLibrary.images)) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
                        <p>Loading media library...</p>
                    </div>
                `;
                return;
            }
            
            let media = mediaLibrary[currentMediaType];
            console.log(`[displayMediaGrid] Showing ${currentMediaType}:`, media);
            
            // Filter images to only show those with public URLs
            if (currentMediaType === 'images') {
                media = media.filter(img => {
                    const imageUrl = img.generatedImageUrl || img.url || img.imageUrl;
                    return imageUrl && (
                        imageUrl.startsWith('http://') || 
                        imageUrl.startsWith('https://') ||
                        imageUrl.includes('storage.googleapis.com') ||
                        imageUrl.includes('googleusercontent.com')
                    );
                });
                console.log(`Filtered ${mediaLibrary.images.length} images to ${media.length} with public URLs`);
            }
            
            grid.innerHTML = '';
            
            if (media.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-state-icon">${currentMediaType === 'videos' ? 'üé¨' : 'üñºÔ∏è'}</div>
                        <p>No ${currentMediaType} ${currentMediaType === 'images' ? 'with public URLs' : ''} found in your library</p>
                        <p style="margin-top: 10px;">Generate some content first!</p>
                    </div>
                `;
                return;
            }

            media.forEach((item, index) => {
                const mediaItem = document.createElement('div');
                mediaItem.className = 'media-item';
                mediaItem.onclick = () => selectMedia(item, currentMediaType);
                
                // Add upload badge and delete button if this is user-uploaded media
                const uploadBadge = item.isUploaded ? `
                    <div class="upload-badge" style="
                        position: absolute;
                        top: 8px;
                        right: 8px;
                        background: #00c9ff;
                        color: white;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 11px;
                        font-weight: 600;
                        z-index: 10;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                    ">UPLOADED</div>
                    <button class="delete-media-btn" onclick="event.stopPropagation(); deleteUploadedMedia('${currentMediaType === 'videos' ? (item.publicUrl || item.googleStorageUrl) : item.url}', '${currentMediaType === 'videos' ? 'video' : 'image'}')" style="
                        position: absolute;
                        top: 8px;
                        left: 8px;
                        background: #ff006e;
                        color: white;
                        border: none;
                        padding: 6px 10px;
                        border-radius: 4px;
                        font-size: 11px;
                        font-weight: 600;
                        cursor: pointer;
                        z-index: 10;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                    ">Delete</button>
                ` : '';
                
                if (currentMediaType === 'videos') {
                    mediaItem.innerHTML = `
                        <video src="${item.publicUrl || item.googleStorageUrl}" muted preload="metadata"></video>
                        <div class="media-item-overlay">${item.title || 'Video ' + (index + 1)}</div>
                        ${uploadBadge}
                    `;
                } else {
                    mediaItem.innerHTML = `
                        <img src="${item.generatedImageUrl || item.url || item.imageUrl}" alt="${item.originalPrompt || item.prompt || 'Generated image'}">
                        <div class="media-item-overlay">${(item.originalPrompt || item.prompt) ? (item.originalPrompt || item.prompt).substring(0, 50) + '...' : 'Image ' + (index + 1)}</div>
                        ${uploadBadge}
                    `;
                }
                
                grid.appendChild(mediaItem);
            });
        }

        // Select media
        function selectMedia(item, type) {
            if (!currentSceneNumber) return;
            
            const url = type === 'videos' 
                ? (item.publicUrl || item.googleStorageUrl)
                : (item.generatedImageUrl || item.url || item.imageUrl);
                
            selectedMedia[currentSceneNumber] = {
                url: url,
                type: type.slice(0, -1) // Remove 's'
            };
            
            // Update placeholder
            const placeholder = document.getElementById(`mediaPlaceholder${currentSceneNumber}`);
            placeholder.innerHTML = type === 'videos'
                ? `<video src="${url}" muted></video>`
                : `<img src="${url}" alt="Selected">`;
            placeholder.classList.add('has-media');
            
            closeMediaModal();
        }

        // Reset form
        function resetForm() {
            // Reset media selections
            for (let i = 1; i <= 4; i++) {
                selectedMedia[i] = null;
                const placeholder = document.getElementById(`mediaPlaceholder${i}`);
                placeholder.innerHTML = '<span class="placeholder-text">Click to select media</span>';
                placeholder.classList.remove('has-media');
            }
            
            // Reset text inputs to defaults
            document.getElementById('text1').value = "Did you know you can automate TikTok, Instagram, and YouTube videos? üî•";
            document.getElementById('text2').value = "Use any video automation tool to replace these text and background assets with your own! üòä";
            document.getElementById('text3').value = "Learn how to get started on the Guides & Tutorials page on Creatomate's home page.";
            document.getElementById('text4').value = "Use the template editor to completely customize this video to meet your own needs. üöÄ";
            
            // Hide preview
            document.getElementById('previewSection').style.display = 'none';
        }

        // Render video
        async function renderVideo() {
            // Check if this is a Creatomate template
            const isCreatomate = currentTemplate.templateType === 'creatomate';
            
            // Validate all media slots have media
            if (isCreatomate) {
                // For Creatomate templates, check media slots
                let missingSlots = [];
                for (let i = 1; i <= (currentTemplate.mediaSlots?.length || 0); i++) {
                    if (!selectedMedia[i]) {
                        missingSlots.push(i);
                    }
                }
                if (missingSlots.length > 0) {
                    alert(`Please select media for slot(s): ${missingSlots.join(', ')}`);
                    return;
                }
            } else {
                // For JSON templates, check scenes
                for (let i = 1; i <= currentTemplate.scenes; i++) {
                    if (!selectedMedia[i]) {
                        alert(`Please select media for Scene ${i}`);
                        return;
                    }
                }
            }

            // Build modifications object
            const modifications = {};
            
            // Add music from the music input field
            const musicInput = document.getElementById('musicUrl');
            if (musicInput && musicInput.value) {
                modifications["Music.source"] = musicInput.value;
            } else {
                // Use template default music if available
                if (currentTemplate.fields) {
                    const musicField = currentTemplate.fields.find(f => f.type === 'music');
                    if (musicField && musicField.defaultValue) {
                        modifications[musicField.name] = musicField.defaultValue;
                    }
                }
                
                // Fallback music URL if not in template and no user input
                if (!modifications["Music.source"]) {
                    modifications["Music.source"] = "https://creatomate.com/files/assets/b5dc815e-dcc9-4c62-9405-f94913936bf5";
                }
            }
            
            // Add text modifications - get all text fields with data-field-name
            const textFields = document.querySelectorAll('[data-field-name]');
            textFields.forEach(field => {
                if (field.value && field.dataset.fieldName) {
                    modifications[field.dataset.fieldName] = field.value;
                }
            });
            
            // Add media modifications
            if (currentTemplate.mediaSlots) {
                currentTemplate.mediaSlots.forEach((slot, index) => {
                    const mediaIndex = isCreatomate ? (index + 1) : slot.scene;
                    if (selectedMedia[mediaIndex]) {
                        modifications[slot.name] = selectedMedia[mediaIndex].url;
                    }
                });
            } else {
                // Fallback for templates without mediaSlots
                for (let i = 1; i <= currentTemplate.scenes; i++) {
                    if (selectedMedia[i]) {
                        modifications[`Background-${i}.source`] = selectedMedia[i].url;
                    }
                }
            }
            
            console.log('Sending modifications:', modifications);
            console.log('Template type:', isCreatomate ? 'Creatomate' : 'JSON');
            
            // Check credits before proceeding
            if (userCredits < CREDITS_PER_VIDEO) {
                alert(`You need ${CREDITS_PER_VIDEO} credits to generate a video. You have ${userCredits} credits.\n\nClick OK to go to the credits page to purchase more.`);
                window.location.href = '/image-credits';
                return;
            }

            // Show loading
            document.getElementById('loadingOverlay').style.display = 'flex';

            try {
                const requestBody = isCreatomate ? {
                    templateId: currentTemplate.creatomateTemplateId,
                    modifications: modifications,
                    isCreatomate: true
                } : {
                    templateId: TEMPLATE_ID,
                    modifications: modifications
                };

                const response = await fetch('/api/editor/render', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (response.ok && data.videoUrl) {
                    // Update credits display after successful generation
                    if (data.creditsRemaining !== undefined) {
                        userCredits = data.creditsRemaining;
                        updateCreditsDisplay();
                    }
                    
                    // Show preview
                    const previewSection = document.getElementById('previewSection');
                    const previewVideo = document.getElementById('previewVideo');
                    
                    previewVideo.src = data.videoUrl;
                    previewSection.style.display = 'block';
                    
                    // Scroll to preview
                    previewSection.scrollIntoView({ behavior: 'smooth' });
                    
                    // Success message with credit info
                    alert(`‚úÖ Video created successfully! \n\n${CREDITS_PER_VIDEO} credits used. You have ${userCredits} credits remaining.\n\nYou can view your video in "My Edits"`);
                } else if (response.status === 402) {
                    // Insufficient credits
                    console.error('Insufficient credits:', data);
                    if (data.redirectTo) {
                        alert(data.message || `You need ${data.creditsNeeded} credits to generate a video. You have ${data.creditsAvailable} credits.\n\nClick OK to go to the credits page to purchase more.`);
                        window.location.href = data.redirectTo;
                    } else {
                        alert(data.message || 'Insufficient credits. Please purchase more credits to continue.');
                    }
                } else {
                    console.error('API Error:', data);
                    let errorMessage = '‚ùå Failed to create video\n\n';
                    if (data.error) {
                        errorMessage += data.error;
                    } else if (data.details) {
                        errorMessage += 'Details: ' + (typeof data.details === 'object' ? JSON.stringify(data.details, null, 2) : data.details);
                    }
                    if (data.status) {
                        errorMessage += '\nStatus: ' + data.status;
                    }
                    alert(errorMessage);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå An error occurred while creating the video');
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // File Upload Functions
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 100MB)
            const maxSize = 100 * 1024 * 1024; // 100MB
            if (file.size > maxSize) {
                showNotification('File too large. Maximum size is 100MB.', 'error');
                return;
            }
            
            // Show selected filename
            document.getElementById('selectedFileName').textContent = file.name;
            
            // Upload file
            await uploadFile(file);
        }
        
        async function uploadFile(file) {
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const uploadStatus = document.getElementById('uploadStatus');
            
            progressDiv.style.display = 'block';
            uploadStatus.textContent = 'Uploading...';
            
            const formData = new FormData();
            formData.append('media', file);
            
            try {
                const xhr = new XMLHttpRequest();
                
                // Track upload progress
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        progressBar.style.width = percentComplete + '%';
                        uploadStatus.textContent = `Uploading... ${Math.round(percentComplete)}%`;
                    }
                });
                
                // Handle completion
                xhr.addEventListener('load', async () => {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        uploadStatus.textContent = 'Upload complete!';
                        progressBar.style.width = '100%';
                        
                        // Refresh media library
                        setTimeout(() => {
                            loadUserMedia();
                            progressDiv.style.display = 'none';
                            progressBar.style.width = '0%';
                            document.getElementById('selectedFileName').textContent = '';
                            document.getElementById('fileInput').value = '';
                        }, 1500);
                        
                        showNotification('File uploaded successfully!', 'success');
                    } else {
                        const error = JSON.parse(xhr.responseText);
                        uploadStatus.textContent = 'Upload failed!';
                        showNotification(error.error || 'Upload failed', 'error');
                    }
                });
                
                // Handle errors
                xhr.addEventListener('error', () => {
                    uploadStatus.textContent = 'Upload failed!';
                    showNotification('Network error during upload', 'error');
                });
                
                // Send request
                xhr.open('POST', '/api/media/upload');
                xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                xhr.send(formData);
                
            } catch (error) {
                console.error('Upload error:', error);
                uploadStatus.textContent = 'Upload failed!';
                showNotification('Failed to upload file', 'error');
            }
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification ' + type;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'error' ? '#ff006e' : '#00c9ff'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Delete uploaded media
        async function deleteUploadedMedia(url, type) {
            if (!confirm(`Are you sure you want to delete this ${type}?`)) {
                return;
            }
            
            try {
                const encodedUrl = encodeURIComponent(url);
                const response = await fetch(`/api/media/upload/${type}/${encodedUrl}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    showNotification(`${type} deleted successfully`, 'success');
                    // Reload media library
                    await loadUserMedia();
                    displayMediaGrid();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to delete media', 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showNotification('Failed to delete media', 'error');
            }
        }
        
        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>